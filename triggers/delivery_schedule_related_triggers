DELIMITER $$
CREATE TRIGGER check_driver
BEFORE INSERT ON driver_roster
FOR EACH ROW
BEGIN
    IF driver_work_hour(NEW.NIC_driver)+ROUND(TIMESTAMPDIFF(MINUTE, NEW.shift_start_time, NEW.shift_end_time)/60) > 40 THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'Cannot insert, working hours exceed the limit';
    END IF;
END$$
DELIMITER ;


DELIMITER $$
CREATE TRIGGER check_driver_assistant
BEFORE INSERT ON driver_assistant_roster
FOR EACH ROW
BEGIN
    IF driver_assistant_work_hour(NEW.NIC_driver_assistant)+ROUND(TIMESTAMPDIFF(MINUTE, NEW.shift_start_time, NEW.shift_end_time)/60) > 60 THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'Cannot insert, working hours exceed the limit';
    END IF;
END$$
DELIMITER ;


DELIMITER $$
CREATE TRIGGER check_delivery_schedule
BEFORE INSERT ON delivery_schedule
FOR EACH ROW
BEGIN
    IF (store_id_by_driver(NEW.NIC_driver)!=store_id_by_driver_assistant(NEW.NIC_driver_assistant) OR store_id_by_driver_assistant(NEW.NIC_driver_assistant)!=store_id_by_truck(NEW.truck_registration_no)  OR store_id_by_driver(NEW.NIC_driver)!=store_id_by_truck(NEW.truck_registration_no) )
    THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'Cannot schedule delivery schedule. driver, driver_assistant, and truck do not belong to the same store';
    END IF;
END$$
DELIMITER ;


DELIMITER $$
CREATE TRIGGER update_delivery_id
BEFORE UPDATE ON order_
FOR EACH ROW
BEGIN
    IF store_id_by_route(OLD.route_id) != store_id_by_deliveryID(NEW.delivery_id) THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Cannot update delivery_id as delivery route is different';
    END IF;
    IF OLD.order_date > (SELECT date FROM delivery_schedule WHERE delivery_id=NEW.delivery_id) THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Cannot update delivery_id as delivery date is not matching';
    END IF;
END$$
DELIMITER ;
